<!DOCTYPE html>
<script 
    src="https://unpkg.com/htmx.org@2.0.2" 
    integrity="sha384-Y7hw+L/jvKeWIRRkqWYfPcvVxHzVzn5REgzbawhxAuQGwX1XWe70vji+VSeHOThJ" 
    crossorigin="anonymous">
</script>

<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recursive Collapsible List</title>
    <style>

    .item-box {
        /* padding: 10px; */
        /* border: 1px solid #ccc; */
        /* margin: 5px 0; */
        background-color: #f9f9f9;
        display: flex;
        flex-direction: column; /* Change to column layout */
        /* max-width: 800px; */
        margin-left: auto;
        margin-right: auto;
    }

    .title-text {
        font-size: 18px;
      /*  margin-bottom: 10px; /* Add spacing below title */ 
    }

    .button-group {
        display: block; /* Change to block */
        gap: 10px; /* Keep gap for spacing */
    }

    .collapse-button {
        cursor: pointer;
        background-color: #007BFF;
        color: white;
        border: none;
        padding: 2px 5px;
        font-size: 10px;
        border-radius: 2px;
        margin-top: 5px; /* Add margin above button */
    }

    .reply-button {
        cursor: pointer;
        background-color: #007BFF;
        color: white;
        border: none;
        padding: 2px 5px;
        font-size: 10px;
        border-radius: 2px;
        margin-top: 5px; /* Add margin above button */
    }

    .collapsible-content {
        padding: 0 18px;
        display: none;
        overflow: hidden;
        background-color: #f1f1f1;
    }

    .reply-box {
        display: none; /* Hidden initially */
        padding: 10px;
        background-color: #f0f0f0;
        border: 1px solid #ccc;
        margin: 5px 0;
        max-width: 800px;
        margin-left: auto;
        margin-right: auto;
    }

    .reply-box textarea {
        width: 100%;
        height: 80px;
        padding: 5px;
        font-size: 14px;
        margin-bottom: 10px; /* Add spacing below textarea */
    }

    .send-button {
        cursor: pointer;
        background-color: #007BFF;
        color: white;
        border: none;
        padding: 5px 15px;
        font-size: 14px;
        border-radius: 5px;
        margin-top: 10px; /* Add margin above button */
    }

    .instructions {
        font-size: 14px;
        color: #666;
        margin-bottom: 5px;
    }

    ul {
        list-style-type: none;
        padding-left: 0;
    }

    ul ul {
        margin-left: -15px; 
    }

    /* New styles for list items */
    li {
        border: 1px solid #ccc; /* Border around list items */
        padding: 10px; /* Padding inside the list item */
        margin: 5px 0; /* Spacing between list items */
        background-color: #f9f9f9; /* Background color for list items */
        border-radius: 5px; /* Rounded corners for list items */
    }
</style>

</head>
<body>

<h2>Mail view with one reply box</h2>

<!-- Recursive template rendering for lists with sub-lists -->
{{block "comment-list-element" .}} 
{{template "list" .}} 
{{end}}
<script>
    var current_comment = "";
    var current_root = window.location.pathname.split('/')[2];
   
    init();
    function init(){
        console.log("initialize");
        console.log("root:",current_root);
        //document.getElementById("form_root").value = current_root;
        var elements = document.getElementsByName("root");
        for(var i = 0; i < elements.length; i++) {
            console.log("found");
            elements[i].value = current_root;
        }
    // JavaScript to handle collapsible actions
    document.querySelectorAll('.collapse-button').forEach(button => {
        button.addEventListener('click', function() {
            const targetId = this.getAttribute('data-target');
            const content = document.getElementById(targetId);
            if (content.style.display === 'block') {
                content.style.display = 'none';
                this.innerHTML = '+';
            } else {
                content.style.display = 'block';
                this.innerHTML = '-';
            }
        });
    });

    // JavaScript to handle reply button actions
    document.querySelectorAll('.reply-button').forEach(button => {
        button.addEventListener('click', function() {
            const replyBoxId = this.getAttribute('data-reply-target');
            const replyBox = document.getElementById(replyBoxId);
            if (replyBox.style.display === 'block') {
                replyBox.style.display = 'none';
            } else {
                replyBox.style.display = 'block';
            }
        });
    });

    // Handle sending (example)
    document.querySelectorAll('.send-button').forEach(button => {
        button.addEventListener('click', function(ccomment) {
            current_comment = ccomment;
        });
    });

    }
    document.addEventListener('htmx:afterSettle',function(evt){

        init();  
        recent = document.getElementById(current_comment).parentElement.children[1]
        //document.getElementById(current_comment).parentElement.nextElementSibling
        console.log(recent.className)
        console.log(recent.tagName)
        if (recent){
            currentItem = recent;
            while (currentItem && currentItem.tagName !== 'BODY'){
                if (currentItem.className==="collapsible-content"){
                    currentItem.style.display = 'block';
                    console.log(currentItem.id)
                    console.log(currentItem.style.display)
                }

                currentItem = currentItem.parentElement;
            }

        }
    });
</script>

</body>
</html>

<!-- Recursive List Template Definition -->
{{define "list"}} 
    <ul id="comment-list" style="list-style-type:none; padding-left: 0;">
        {{ $itemId := ("") }} <!-- Unique ID for each item -->
        {{ $replyBoxId := ("") }} <!-- Unique ID for each reply box -->
        {{ $collapseContentId := ("") }} <!-- Unique ID for each collapsible content -->
    {{range .}} 
        <li>        
            {{ $itemId = (printf "item-%s" .Id) }} <!-- Unique ID for each item -->
            {{ $replyBoxId = (printf "reply-box-%s" .Id) }} <!-- Unique ID for each reply box -->
            {{ $collapseContentId = (printf "collapse-content-%s" .Id) }} <!-- Unique ID for each collapsible content -->
        
            <div class="item-box">
                <span class="title-text">{{.Message}}</span>

            </div>
            <!-- Reply box that will show/hide when reply button is clicked -->
        </li>
    {{end}} 
    <div class="button-group">
        <!-- Reply button for all items -->
        <button class="reply-button" data-reply-target="{{ $replyBoxId }}">Reply</button>
    </div>
    <div id="{{ $replyBoxId }}" class="reply-box">
        <div class="instructions">Enter your reply below:</div>
    <!--     <textarea placeholder="Write your reply here..."></textarea> -->
    <!--     <button class="send-button">Send</button> -->
       <form hx-swap="innerHTML" hx-target="#comment-list" hx-post="/mailadd"> 
            <input type = "hidden" name = "parent" value = "{{ $replyBoxId }}" />
            <input type = "hidden" name = "root" class="root_input" value = "" />
           <!-- <input type="textarea" name="comment" id="comment" placeholder="Write your reply here..."> -->
            <textarea name="comment" id="comment" placeholder="Write your reply here..." rows="4" cols="50"></textarea>
            <input value="Submit" type="submit" onclick='current_comment = "{{ $replyBoxId }}";'> 
            
        </form>
    </div>
    </ul>
{{end}} 